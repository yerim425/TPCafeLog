<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카페로그 지도화면</title>
    <script>
        
    </script>
</head>
<body>
    <div id="map" style="width: 100%; height: 100vh;">
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7d2594d51002a4ba8bcd20ceb529f408&libraries=clusterer"></script>

    <script>
        var mapContainer = document.getElementById('map');
        var centerPos = new kakao.maps.LatLng(35.1795543, 129.0756416); // 기본 위치
        mapOption = {
            center: centerPos, 
            level: 5
        };
        // 카카오 지도
        var map = new kakao.maps.Map(mapContainer, mapOption);

        // 마커 클러스터러를 생성합니다 
        var clusterer = new kakao.maps.MarkerClusterer({
            map: map,               // 마커들을 클러스터로 관리하고 표시할 지도 객체 
            averageCenter: true,    // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정 
            minLevel: 5             // 클러스터 할 최소 지도 레벨 
        });

        //마커 이미지
        var imgSize = new kakao.maps.Size(32,32);
        var myPinImg = new kakao.maps.MarkerImage("./images/ic_my_pin.png", imgSize);
        // 카페 마커 이미지
        var cafePinImg = new kakao.maps.MarkerImage("./images/ic_cafe_pin.png", imgSize);


        // 지도 중심을 내 위치로 세팅
        function setMyLocation(lat, lng){
            console.log("내 위치 : ", lat , lng);

            // 지도 중심을 내 위치로 이동
            centerPos = new kakao.maps.LatLng(lat, lng);
            map.setCenter(centerPos);

            // 내 위치 마커 표시
            var marker = new kakao.maps.Marker({
                position: centerPos,
                image: myPinImg 
            })
            marker.setMap(map);
        }
        setMyLocation(centerPos.getLat(), centerPos.getLng());

        var page = 1;

        // kakao 로컬 카테고리 검색
        async function searchCafe() {
            // 센터 위치
            const lat = centerPos.getLat();
            const lng = centerPos.getLng();
            console.log(lat, lng);

            var bounds = map.getBounds(); // 현재 지도 영역
            var sw = bounds.getSouthWest(); // 남서쪽 좌표
            var ne = bounds.getNorthEast(); // 북동쪽 좌표
            var rect = `${sw.getLng()},${sw.getLat()},${ne.getLng()},${ne.getLat()}`;
            console.log("rect:", rect);

            const url = `https://dapi.kakao.com/v2/local/search/category.json?category_group_code=CE7&x=${lat}&y=${lng}&radius=2000&page=${page}&rect=${rect}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        Authorization: "KakaoAK 4d2a57ec2a45ae21cfa73a4abafe38a6" // REST API 키
                    }
                });

                if (!response.ok) {
                    throw new Error("API 요청 실패: " + response.status);
                }

                const data = await response.json();
                console.log(data);
                setCafeDatas(data);
            } catch (error) {
                console.error("에러: " + error);
            }
        }
        searchCafe();

        // 카카오에서 가져온 데이터로 마커를 생성하고 클러스터러 객체에 넘겨줌
        function setCafeDatas(data){
            if(!data.meta.is_end){
                page++;
                searchCafe();
            }
            var markers = data.documents.map(function(cafe){
                return new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(cafe.y, cafe.x),
                    image: cafePinImg
                });
            });
            // 클러스터러에 마커들을 추가
            clusterer.addMarkers(markers);
        }

        // 지도 이동 시 centerPos 가져와서 카페 정보 요청

    </script>
</body>
</html>
